## Overview
[Dependency Analysis Plugin](https://github.com/autonomousapps/dependency-analysis-android-gradle-plugin) helps to detect unused dependencies in the b2c project. The `Run-Dependency-Analysis` CI workflow runs for every PR and if a dependency violation in the affected modules is found it will report them in a comment and fail the build.
To check if there are unused dependencies locally, just run `./gradlew module-name:projectHealth` command and see the output.

## What to do when dependency check didn't pass?

In most cases removing the reported dependency manually will be sufficient.

## Troubleshooting

If the project doesn't build after removing the unused dependency, it means that one of the edge cases has occurred:

### Removed dependency was only used to access another dependency, and now this dependency is not accessible anymore.
*Let’s say module A depends on library B which depends on library C, and A doesn’t use any classes from B but uses classes declared in C. In this case, the plugin will mark B as unused, and when you remove it, A won’t compile anymore since it lost access to C. [Issue](https://github.com/autonomousapps/dependency-analysis-android-gradle-plugin/issues/686)*

**How to fix?**

Declare a direct dependency on **C**, instead of on **B**. The *“Transitively used dependencies”* section of the comment generated by the plugin will help you find the **C** dependency.

[Demo PR to showcase the issue] (https://github.com/deliveryhero/pd-mob-b2c-android/pull/17414)

### Removed dependency was used only at runtime
The plugin’s primary focus at this time is analysis of compile-time dependencies. As such, you may see incorrect advice (“remove X dependency, it’s unused”) if that dependency is only used at runtime. An example of this is if the dependency is only used via reflection.

**How to fix?**

Exclude this dependency from the dependency analysis, to avoid incorrect reporting. Go to the root level `build.gradle` and add the dependency to proper module in the `depencencyAnalysis{}` block as follows:

```
project(":error-monitoring") {  // module with incorrectly reported dependency
    onUnusedDependencies {  
        ignore(libs.androidxCore) // coma separated dependencies to exclude from the check
    }  
}
```

### Removed dependency was used only for accessing R references

Given a multi-project build with two modules, A and B, and A depends on B (A → B), the plugin will emit a false positive indicating B is unused in A (inaccurately), when A only uses Android `R` references from B and those references _are not namespaced_ (`android.nonTransitiveRClass` is not set to `true` in the project's  `gradle.properties` file).

**How to fix?**

The fix will be the same as for the previous case - just exclude this dependency from the dependency analysis.

```
project(":error-monitoring") {  // module with incorrectly reported dependency
    onUnusedDependencies {  
        ignore(libs.androidxCore) // coma separated dependencies to exclude from the check
    }  
}

```

### Why unused dependency is not reported?
In some cases, you might expect some dependency to be reported as unused, but the plugin doesn't treat it as such. To learn why, you can run `reason` command:

```
./gradlew module-name:reason --id com.squareup.okio:okio
```

The output will show you the usage of the dependency.

## Links
1. https://github.com/autonomousapps/dependency-analysis-android-gradle-plugin
2. https://dev.to/autonomousapps/dependency-analysis-gradle-plugin-using-bytecode-analysis-to-find-unused-dependencies-509n
3. https://dev.to/autonomousapps/the-proper-care-and-feeding-of-your-gradle-build-d8g
